<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹¤ì‹œê°„ ìŒì„± ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸</title>
  <style>
    :root { --bg:#0b0d10; --panel:#12161b; --text:#e7efff; --muted:#7e8b9f; --acc:#4da3ff; --red:#ff5c5c; --green:#32d74b; --amber:#ffd166; }
    * { box-sizing: border-box }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; background:var(--bg); color:var(--text) }
    header { padding:20px 16px; border-bottom:1px solid #1d2430; background:linear-gradient(180deg,#0f1318,transparent) }
    main { max-width: 920px; margin: 0 auto; padding: 24px 16px 60px }
    h1 { margin:0 0 6px; font-size: 22px }
    p.sub { margin:0; color:var(--muted) }
    .card { background:var(--panel); border:1px solid #1d2430; border-radius:14px; padding:16px; margin-top:16px; }
    label { font-size: 14px; color: var(--muted); display:block; margin-bottom:6px }
    input[type="text"], select {
      width:100%; background:#0e1217; color:var(--text); border:1px solid #1f2633; border-radius:10px;
      padding:10px 12px; font-size:14px; outline:none;
    }
    .row { display:grid; grid-template-columns: 1fr 200px; gap:12px }
    .btns { display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap: wrap; }
    button {
      cursor:pointer; border:1px solid #243145; background:#162033; color:#cfe4ff; border-radius:12px;
      padding:10px 14px; font-weight:600; transition: transform .02s ease-in-out, background .2s;
    }
    button:hover { background:#1b2a41 }
    button:active { transform: translateY(1px) }
    button[disabled] { opacity:.5; cursor:not-allowed }
    .log { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0a0e14; color:#8fbcff;
      border:1px solid #1c2433; border-radius:12px; padding:12px; min-height:160px; white-space:pre-wrap; overflow:auto }
    .status { display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px; margin:6px 0 0 }
    .dot { width:10px; height:10px; border-radius:50%; background:#5a6473 }
    .dot.on { background:var(--green); box-shadow:0 0 0 3px rgba(50,215,75,.12) }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#0e1829; border:1px solid #20314a; color:#b8d7ff; font-size:12px }
    .result { background:#0c1118; border:1px dashed #223146; border-radius:12px; padding:12px; margin-top:10px }
    .transcript { color: var(--text); }
    .live-line { margin-top:8px; font-size:14px; color:#c8d8f5 }
    .highlight { color: var(--acc); font-weight:600; }
    .risk-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-top:10px; }
    .risk-cell { border:1px solid #1f2a3b; border-radius:10px; padding:10px; background:#0b1424; }
    .risk-cell .label { font-size:12px; color:#8aa5cf; text-transform:uppercase; letter-spacing:.05em }
    .risk-cell .value { font-size:22px; font-weight:600; margin:6px 0; color:#ffffff }
    .risk-cell .desc { font-size:13px; color:#9db4e0 }
    .risk-cell .keywords { font-size:12px; color:#a8bedf; margin-top:6px; min-height:16px }
    .history { margin-top:12px; background:#0c151f; border:1px solid #1f3047; border-radius:12px; padding:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#b0c8ec; max-height:220px; overflow:auto }
    .history h3 { margin:0 0 6px; font-size:14px; color:#d6e4ff }
    .history-entry { margin-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.05); padding-bottom:6px }
    .history-entry:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0 }
    .history-entry .label { font-size:12px; color:#86a2c7 }
    .metrics { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px }
    .metric { font-size:12px; color:#c6d9f7; border:1px solid #223146; background:#0b1424; padding:4px 8px; border-radius:10px }
    .banner { margin-top:10px; padding:10px 12px; border-radius:12px; font-size:14px; display:none }
    .banner.err { background:#2a0f12; border:1px solid #4a1b20; color:#ffb3b3; }
    .banner.ok  { background:#0f1f14; border:1px solid #1e3a26; color:#b8ffd0; }
    .footer { margin-top:16px; font-size:13px; color:#92a2ba }
    a { color:var(--acc); text-decoration:none }
    .links { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ™ï¸ ì‹¤ì‹œê°„ ìŒì„± ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸</h1>
    <p class="sub">ë§ˆì´í¬ â†’ 16k PCM(<b>20msÃ—5 = 100ms ë°°ì¹˜</b>) â†’ WebSocket(<code>/api/transcribe/ws</code>) â†’ ì¸ì‹ ê²°ê³¼</p>
  </header>

  <main>
    <div class="card">
      <div id="bannerErr" class="banner err"></div>
      <div id="bannerOk"  class="banner ok"></div>

      <div class="row">
        <div>
          <label>WebSocket URL (ìë™ ì™„ì„±ë¨, í•„ìš”ì‹œ ìˆ˜ì •)</label>
          <input id="wsUrl" type="text" spellcheck="false" />
        </div>
        <div>
          <label>ì–¸ì–´(Language)</label>
          <select id="lang">
            <option value="ko-KR" selected>ko-KR (Korean)</option>
            <option value="en-US">en-US (English)</option>
            <option value="ja">ja (Japanese)</option>
            <option value="zh-CN">zh-CN (Chinese Simplified)</option>
            <option value="zh-TW">zh-TW (Chinese Traditional)</option>
          </select>
        </div>
      </div>

      <div class="btns">
        <button id="btnStart">ğŸ¤ Start</button>
        <button id="btnStop" disabled>â¹ Stop</button>
        <span class="status"><span id="wsDot" class="dot"></span> <span id="wsStatus">Disconnected</span></span>
        <span class="pill" id="fmtInfo">PCM: 16kHz â€¢ mono â€¢ S16LE â€¢ 100ms batch</span>
      </div>

      <div class="metrics">
        <span class="metric">â± <span id="mDur">00:00</span></span>
        <span class="metric">â¬† sent <span id="mBytes">0</span> B</span>
        <span class="metric">ğŸ“ˆ <span id="mRate">0</span> B/s</span>
      </div>

      <div class="result" id="resultBox">
        <div><strong>ê²°ê³¼(ì‹¤ì‹œê°„)</strong></div>
        <div class="live-line">í˜„ì¬ partial: <span id="partialText" class="highlight">-</span></div>
        <div id="transcript" class="transcript"></div>
      </div>

      <div class="result" id="riskBox">
        <div><strong>ìœ„í—˜ë„ ëª¨ë‹ˆí„°</strong></div>
        <div class="risk-grid">
          <div class="risk-cell">
            <div class="label">ëˆ„ì (ì„¸ì…˜)</div>
            <div class="value" id="cumProb">0%</div>
            <div class="desc" id="cumInfo">level 0 Â· ìœ í˜• ì—†ìŒ</div>
            <div class="keywords" id="cumKeywords"></div>
          </div>
          <div class="risk-cell">
            <div class="label">ìµœê·¼ ì¡°ê°</div>
            <div class="value" id="chunkProb">-</div>
            <div class="desc" id="chunkInfo">ë°ì´í„° ì—†ìŒ</div>
          </div>
          <div class="risk-cell">
            <div class="label">KoBERT ì¢…í•©</div>
            <div class="value" id="kobertVal">-</div>
            <div class="desc" id="kobertInfo">ëˆ„ì  ë¬¸ì¥ ëŒ€ê¸° ì¤‘</div>
          </div>
        </div>
      </div>
      <div class="history" id="historyBox">
        <h3>ëˆ„ì  ë¬¸ì¥</h3>
        <p id="historyList">(ëŒ€ê¸° ì¤‘)</p>
      </div>

      <div style="margin-top:10px">
        <label>ì´ë²¤íŠ¸ ë¡œê·¸</label>
        <div id="log" class="log"></div>
      </div>

      <div class="footer">
        ìœ ìš©í•œ ë§í¬:
        <div class="links">
          <a href="/docs" target="_blank">Swagger (/docs)</a>
          <a href="/redoc" target="_blank">ReDoc (/redoc)</a>
          <a href="/healthz" target="_blank">Health Check</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ------------ UI refs ------------
    const wsUrlEl   = document.getElementById('wsUrl');
    const langEl    = document.getElementById('lang');
    const btnStart  = document.getElementById('btnStart');
    const btnStop   = document.getElementById('btnStop');
    const wsDot     = document.getElementById('wsDot');
    const wsStatus  = document.getElementById('wsStatus');
    const logEl     = document.getElementById('log');
    const transcriptEl = document.getElementById('transcript');
    const partialEl = document.getElementById('partialText');
    const bannerErr = document.getElementById('bannerErr');
    const bannerOk  = document.getElementById('bannerOk');
    const mDur      = document.getElementById('mDur');
    const mBytes    = document.getElementById('mBytes');
    const mRate     = document.getElementById('mRate');
    const cumProbEl = document.getElementById('cumProb');
    const cumInfoEl = document.getElementById('cumInfo');
    const cumKeywordsEl = document.getElementById('cumKeywords');
    const chunkProbEl = document.getElementById('chunkProb');
    const chunkInfoEl = document.getElementById('chunkInfo');
    const kobertValEl = document.getElementById('kobertVal');
    const kobertInfoEl = document.getElementById('kobertInfo');
    const historyListEl = document.getElementById('historyList');

    // ------------ State ------------
    let ws = null;
    let audioCtx = null;
    let workletNode = null;
    let stream = null;
    let fullTranscript = '';
    let startTs = 0;
    let timerId = null;
    let sentBytes = 0;
    let lastBytes = 0;
    let stopping = false;

    const sleep = (ms) => new Promise(res => setTimeout(res, ms));

    // ------------ Utils ------------
    function showErr(msg) { bannerErr.style.display='block'; bannerErr.textContent = 'âš  ' + msg; }
    function hideErr()    { bannerErr.style.display='none'; bannerErr.textContent = ''; }
    function showOk(msg)  { bannerOk.style.display='block';  bannerOk.textContent = 'âœ… ' + msg; setTimeout(()=>{bannerOk.style.display='none';}, 2000); }

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logEl.textContent += `[${now}] ${msg}\n`;
      const lines = logEl.textContent.split('\n');
      if (lines.length > 300) logEl.textContent = lines.slice(-300).join('\n');
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setWS(on) {
      wsDot.classList.toggle('on', !!on);
      wsStatus.textContent = on ? 'Connected' : 'Disconnected';
    }
    function defaultWsUrl(lang) {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      return `${proto}://${location.host}/api/transcribe/ws?sr=16000&lang=${encodeURIComponent(lang)}`;
    }
    function fmtDur(ms) {
      const s = Math.floor(ms/1000), m = Math.floor(s/60), ss = s%60;
      return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }
    function startMeter() {
      startTs = Date.now(); sentBytes = 0; lastBytes = 0;
      if (timerId) clearInterval(timerId);
      timerId = setInterval(()=>{
        const dur = Date.now() - startTs;
        mDur.textContent = fmtDur(dur);
        mBytes.textContent = sentBytes.toLocaleString();
        const rate = Math.max(0, sentBytes - lastBytes);
        mRate.textContent = rate.toLocaleString();
        lastBytes = sentBytes;
      }, 1000);
    }
    function stopMeter() { if (timerId) clearInterval(timerId); timerId = null; }

    function describeType(t) { return t || 'ìœ í˜• ì—†ìŒ'; }
    function fmtProb(prob) {
      const n = Number(prob);
      if (Number.isNaN(n)) return '-';
      return `${n.toFixed(1)}%`;
    }
    function updateCumulative(data) {
      if (!data) {
        cumProbEl.textContent = '-';
        cumInfoEl.textContent = 'ë°ì´í„° ì—†ìŒ';
        cumKeywordsEl.textContent = '';
        return;
      }
      const prob = Number(data.probability ?? 0);
      cumProbEl.textContent = fmtProb(prob);
      const level = data.level ?? 0;
      cumInfoEl.textContent = `level ${level} Â· ${describeType(data.phishing_type)}`;
      const keywords = (data.keywords || []).filter(Boolean);
      cumKeywordsEl.textContent = keywords.length ? `í‚¤ì›Œë“œ: ${keywords.join(', ')}` : '';
    }
    function updateChunk(data) {
      if (!data) {
        chunkProbEl.textContent = '-';
        chunkInfoEl.textContent = 'ë°ì´í„° ì—†ìŒ';
        return;
      }
      chunkProbEl.textContent = fmtProb(data.probability ?? 0);
      const level = data.level ?? 0;
      const type = data.phishing_type ? ` Â· ${data.phishing_type}` : '';
      chunkInfoEl.textContent = `level ${level}${type}`;
    }
    function updateKobert(data) {
      if (!data) {
        kobertValEl.textContent = '-';
        kobertInfoEl.textContent = 'ëˆ„ì  ë¬¸ì¥ ëŒ€ê¸° ì¤‘';
        return;
      }
      const conf = Number(data.confidence ?? 0) * 100;
      kobertValEl.textContent = data.is_phishing ? `ìœ„í—˜ (${conf.toFixed(1)}%)` : `ì •ìƒ (${conf.toFixed(1)}%)`;
      const len = data.analyzed_length ?? 0;
      kobertInfoEl.textContent = `ë¶„ì„ ê¸¸ì´ ${len}ì Â· ${data.method || 'kobert'}`;
    }

    function renderHistory(entries) {
      if (!Array.isArray(entries)) { historyListEl.textContent = '(ëŒ€ê¸° ì¤‘)'; return; }
      const combined = entries
        .filter(e => e && e.text)
        .map(e => e.text.trim())
        .filter(Boolean);
      historyListEl.textContent = combined.length ? combined.join(' ') : '(ëŒ€ê¸° ì¤‘)';
    }

    function handleTranscript(kind, text) {
      if (kind === 'partial') {
        partialEl.textContent = text || '';
        return;
      }
      if (kind === 'final') {
        partialEl.textContent = '';
        if (text) {
          fullTranscript = (fullTranscript ? `${fullTranscript} ` : '') + text;
          transcriptEl.textContent = fullTranscript;
        }
      }
    }

    function wsMessageHandler(e) {
      try {
        const msg = JSON.parse(e.data);
        if (msg.debug) {
          log('DEBUG: ' + msg.debug);
          return;
        }
        if (msg.error) {
          showErr(msg.message || msg.error);
          log('Server error: ' + JSON.stringify(msg));
          return;
        }
        if (!msg.kind) {
          log('Server: ' + e.data);
          return;
        }
        if (msg.kind === 'state') {
          log(`STATE: ${msg.text || ''}`);
          return;
        }
        if (msg.kind === 'partial' || msg.kind === 'final') {
          handleTranscript(msg.kind, msg.text || '');
          updateCumulative(msg.immediate || null);
          if (msg.chunk_immediate) updateChunk(msg.chunk_immediate);
          if (msg.history) renderHistory(msg.history);
        } else if (msg.kind === 'risk') {
          updateCumulative(msg.immediate || null);
          updateKobert(msg.comprehensive || null);
          if (msg.history) renderHistory(msg.history);
        } else {
          log(`MSG(${msg.kind}): ${JSON.stringify(msg)}`);
        }
      } catch (err) {
        log('Error processing message: ' + err);
      }
    }

    wsUrlEl.value = defaultWsUrl(langEl.value);
    langEl.addEventListener('change', () => {
      try { const u = new URL(wsUrlEl.value); u.searchParams.set('lang', langEl.value); wsUrlEl.value = u.toString(); }
      catch { wsUrlEl.value = defaultWsUrl(langEl.value); }
    });

    async function start() {
      hideErr();
      if (ws && ws.readyState === 1) {
        showErr('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      btnStart.disabled = true; btnStop.disabled = false;
      fullTranscript = '';
      transcriptEl.textContent = '';
      partialEl.textContent = '-';
      updateCumulative(null);
      updateChunk(null);
      updateKobert(null);
      historyListEl.innerHTML = '';
      const url = wsUrlEl.value.trim();

      ws = new WebSocket(url);
      ws.binaryType = 'arraybuffer';
      ws.onopen = () => { setWS(true); log('WS âœ… connected'); showOk('WebSocket ì—°ê²° ì„±ê³µ'); startMeter(); };
      ws.onclose = async () => {
        setWS(false);
        log('WS âŒ closed');
        if (!stopping) {
          showErr('WebSocket ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          await stop(true);
        }
      };
      ws.onerror = (e) => { log('WS error: ' + (e?.message || e)); showErr('WebSocket ì˜¤ë¥˜: ' + (e?.message || 'unknown')); };
      ws.onmessage = wsMessageHandler;

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true },
          video: false
        });
      } catch (err) {
        log('ë§ˆì´í¬ ê¶Œí•œ ì‹¤íŒ¨: ' + err);
        showErr('ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
        await stop(true);
        return;
      }

      const PACK_FRAMES = 5;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
        const workletCode = `
          class DownsampleChunker extends AudioWorkletProcessor {
            constructor(){ super(); this._ratio = sampleRate/16000; this._acc = 0; this._cnt = 0; this._buf = []; this._FRAME = 320; this._PACK_FRAMES = ${PACK_FRAMES}; this._pending = []; }
            process(inputs){
              const ch = inputs[0]?.[0]; if(!ch) return true;
              for(let i=0;i<ch.length;i++){
                this._acc += ch[i]; this._cnt++;
                if(this._cnt >= this._ratio){
                  const s = Math.max(-1, Math.min(1, this._acc / this._cnt));
                  this._buf.push(s); this._acc = 0; this._cnt = 0;
                  if(this._buf.length >= this._FRAME){
                    const frame = this._buf.splice(0, this._FRAME);
                    const bytes = new ArrayBuffer(this._FRAME * 2);
                    const view = new DataView(bytes);
                    for(let j=0;j<this._FRAME;j++){ view.setInt16(j*2, (frame[j]*32767)|0, true); }
                    this._pending.push(bytes);
                    if (this._pending.length >= this._PACK_FRAMES){
                      let total = 0; for (const ab of this._pending) total += ab.byteLength;
                      const packed = new Uint8Array(total); let off = 0;
                      for (const ab of this._pending){ packed.set(new Uint8Array(ab), off); off += ab.byteLength; }
                      this._pending.length = 0;
                      this.port.postMessage(packed.buffer, [packed.buffer]);
                    }
                  }
                }
              }
              return true;
            }
          }
          registerProcessor('downsample-chunker', DownsampleChunker);
        `;
        const blob = new Blob([workletCode], { type: 'application/javascript' });
        const modUrl = URL.createObjectURL(blob);
        await audioCtx.audioWorklet.addModule(modUrl);
        const source = audioCtx.createMediaStreamSource(stream);
        workletNode = new AudioWorkletNode(audioCtx, 'downsample-chunker');
        workletNode.port.onmessage = (e) => {
          if (ws && ws.readyState === 1 && ws.bufferedAmount < 512 * 1024) {
            ws.send(e.data);
            sentBytes += (e.data?.byteLength || 0);
          }
        };
        source.connect(workletNode);
        log(`AudioWorklet on. in:${audioCtx.sampleRate} â†’ out:16000Hz S16LE (20msÃ—${PACK_FRAMES}=${20*PACK_FRAMES}ms batch)`);
      } catch (err) {
        log('AudioWorklet failed, falling back. Error: ' + err);
      }

      log("ğŸ™ï¸ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ â€” ë§í•´ë³´ì„¸ìš”!");
    }

    async function stop(silent=false) {
      if (stopping) return;
      stopping = true;
      btnStart.disabled = false; btnStop.disabled = true;
      if (!silent) log('ì •ì§€ ì¤‘â€¦');

      try {
        try { if (workletNode) workletNode.disconnect(); } catch {}
        workletNode = null;
        try { if (audioCtx) await audioCtx.close(); } catch {}
        audioCtx = null;
        try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch {}
        stream = null;
        if (ws) {
          try {
            if (ws.readyState === 1) {
              ws.send("__END__");
              await sleep(150);
              ws.close();
            } else if (ws.readyState === 0) {
              ws.close();
            }
          } catch (err) {
            console.warn(err);
          }
        }
      } finally {
        ws = null;
        stopMeter();
        setWS(false);
        partialEl.textContent = '-';
        updateCumulative(null);
        updateChunk(null);
        updateKobert(null);
        historyListEl.innerHTML = '';
        if (!silent) { log('ğŸ”š stopped'); }
        stopping = false;
      }
    }

    btnStart.addEventListener('click', start);
    btnStop.addEventListener('click', () => stop(false));
  </script>
</body>
</html>
